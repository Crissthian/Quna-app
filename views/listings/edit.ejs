<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quna</title>
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/editlisting.css">

</head>

<body>
  <div class="floating-elements"></div>

  <%- include("../includes/navbar.ejs") %>

    <div class="container edit-container">
      <div class="edit-header">
        <h2 class="edit-title">
          <i class="fas fa-edit me-3" style="color: var(--primary-color);"></i>
          Editar Propiedad
        </h2>
        <p class="edit-subtitle">Actualiza los detalles de tu propiedad</p>
      </div>

      <div class="form-step-indicator">
        <div class="step-dot active"></div>
        <div class="step-dot active"></div>
        <div class="step-dot active"></div>
        <div class="step-dot active"></div>
        <div class="step-dot active"></div>
        <div class="step-dot active"></div>
      </div>

      <div class="form-container">
        <form action="/listings/<%= listing._id %>?_method=PUT" method="POST" class="needs-validation"
              enctype="multipart/form-data">

          <div class="form-group-enhanced mb-3">
            <label for="title" class="form-label form-label-enhanced">
              <i class="fas fa-heading label-icon"></i>
              Título:
            </label>
            <input type="text" name="listing[title]" value="<%= listing.title %>" id="title"
                   class="form-control form-control-enhanced input-hover" required>
            <div class="valid-feedback valid-feedback-enhanced">
              <i class="fas fa-check-circle"></i>
              ¡Todo bien!
            </div>
            <div class="invalid-feedback invalid-feedback-enhanced">
              <i class="fas fa-exclamation-circle"></i>
              Por favor, ingresa un título.
            </div>
          </div>

          <div class="form-group-enhanced mb-3">
            <label for="description" class="form-label form-label-enhanced">
              <i class="fas fa-align-left label-icon"></i>
              Descripción:
            </label>
            <input type="text" name="listing[description]" value="<%= listing.description %>"
                   class="form-control form-control-enhanced input-hover" required>
            <div class="valid-feedback valid-feedback-enhanced">
              <i class="fas fa-check-circle"></i>
              ¡Todo bien!
            </div>
            <div class="invalid-feedback invalid-feedback-enhanced">
              <i class="fas fa-exclamation-circle"></i>
              Por favor, ingresa una descripción.
            </div>
          </div>

          <div class="form-group-enhanced mb-3">
            <label for="category" class="form-label form-label-enhanced">
              <i class="fas fa-layer-group label-icon"></i>
              Categoría:
            </label>
            <select name="listing[category]" id="category" class="form-control form-control-enhanced input-hover"
                    required>
              <option value="rooms" <%=listing.category==="rooms" ? "selected" : "" %>>Habitaciones</option>
              <option value="cities" <%=listing.category==="cities" ? "selected" : "" %>>Ciudades Icónicas</option>
              <option value="mountains" <%=listing.category==="mountains" ? "selected" : "" %>>Montañas</option>
              <option value="castles" <%=listing.category==="castles" ? "selected" : "" %>>Castillos</option>
              <option value="pools" <%=listing.category==="pools" ? "selected" : "" %>>Piscinas Asombrosas</option>
              <option value="camping" <%=listing.category==="camping" ? "selected" : "" %>>Camping</option>
              <option value="farms" <%=listing.category==="farms" ? "selected" : "" %>>Granjas</option>
              <option value="beach" <%=listing.category==="beach" ? "selected" : "" %>>Frente a la Playa</option>
              <option value="luxury" <%=listing.category==="luxury" ? "selected" : "" %>>Lujo</option>
              <option value="cabins" <%=listing.category==="cabins" ? "selected" : "" %>>Cabañas</option>
              <option value="boats" <%=listing.category==="boats" ? "selected" : "" %>>Botes</option>
            </select>
            <div class="invalid-feedback invalid-feedback-enhanced">
              <i class="fas fa-exclamation-circle"></i>
              Por favor, selecciona una categoría.
            </div>
          </div>


          <div class="form-group-enhanced mb-3">
            <label for="imageUrl" class="form-label form-label-enhanced">
              <i class="fas fa-image label-icon"></i>
              Vista Previa de la Imagen Actual:
            </label>
            <img src="<%= listing.image.url %>" alt="Old Preview" class="img-fluid">
          </div>

          <div class="form-group-enhanced mb-3">
            <label for="imageUrl" class="form-label form-label-enhanced">
              <i class="fas fa-image label-icon"></i>
              Subir Imagen:
            </label>
            <input type="file" name="listing[image]" class="form-control form-control-enhanced input-hover">
            <div class="invalid-feedback invalid-feedback-enhanced">
              <i class="fas fa-exclamation-circle"></i>
              Por favor, sube una imagen válida.
            </div>
          </div>

          <div class="form-group-enhanced mb-3">
            <label for="price" class="form-label form-label-enhanced">
              <i class="fas fa-sack-dollar label-icon"></i>
              Precio:
            </label>
            <div class="input-group-enhanced">
              <span class="input-prefix">S/</span>
              <input type="number" name="listing[price]" value="<%= listing.price %>"
                     class="form-control form-control-enhanced with-prefix input-hover" required min="0" step="0.01"
                     onkeypress="return event.charCode >= 48 && event.charCode <= 57 || event.charCode === 46">
            </div>
            <div class="valid-feedback valid-feedback-enhanced">
              <i class="fas fa-check-circle"></i>
              Se ve bien!
            </div>
            <div class="invalid-feedback invalid-feedback-enhanced">
              <i class="fas fa-exclamation-circle"></i>
              Por favor, ingresa un precio válido.
            </div>
          </div>

          <div class="form-group-enhanced mb-3">
            <label for="location" class="form-label form-label-enhanced">
              <i class="fas fa-map-marker-alt label-icon"></i>
              Ubicación:
            </label>
            <input type="text" name="listing[location]" value="<%= listing.location %>"
                   class="form-control form-control-enhanced input-hover" required>
            <div class="valid-feedback valid-feedback-enhanced">
              <i class="fas fa-check-circle"></i>
              Se ve bien!
            </div>
            <div class="invalid-feedback invalid-feedback-enhanced">
              <i class="fas fa-exclamation-circle"></i>
              Por favor, ingresa una ubicación.
            </div>
          </div>

          <div class="form-group-enhanced mb-4">
            <label for="country" class="form-label form-label-enhanced">
              <i class="fas fa-flag label-icon"></i>
              País:
            </label>
            <input type="text" name="listing[country]" value="<%= listing.country %>"
                   class="form-control form-control-enhanced input-hover" required>
            <div class="valid-feedback valid-feedback-enhanced">
              <i class="fas fa-check-circle"></i>
              Se ve bien!
            </div>
            <div class="invalid-feedback invalid-feedback-enhanced">
              <i class="fas fa-exclamation-circle"></i>
              Por favor, ingresa un país.
            </div>
          </div>

          <button type="submit" class="btn submit-button">
            <i class="fas fa-save me-2"></i>
            Actualizar Anuncio
          </button>
        </form>
      </div>
    </div>

    <script>
      document.getElementById("price").addEventListener("input", function (e) {
        this.value = this.value.replace(/[^0-9.]/g, ""); // strip non-numeric chars
      });
    </script>
    <script>
      (() => {
        'use strict';
        const forms = document.querySelectorAll('.needs-validation');
        Array.from(forms).forEach(form => {
          form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
              console.log("❌ Form blocked by client-side validation");
            } else {
              console.log("✅ Form is valid, submitting");
              form.classList.add('success-animation');
            }
            form.classList.add('was-validated');
          }, false);
        });

        const inputs = document.querySelectorAll('.form-control-enhanced');
        inputs.forEach(input => {
          input.addEventListener('input', function () {
            if (this.checkValidity()) {
              this.classList.add('is-valid');
              this.classList.remove('is-invalid');
            } else {
              this.classList.add('is-invalid');
              this.classList.remove('is-valid');
            }
          });
        });
      })();
    </script>

    <%- include("../includes/footer.ejs") %>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
              integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
              crossorigin="anonymous"></script>

</body>

</html>